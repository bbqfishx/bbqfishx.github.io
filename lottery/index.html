<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ä¸€ç•ªè³æŠ½çæ´»å‹•</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: 'var(--primary, #BBA0CB)',
            dark: 'var(--dark, #7E5A9B)',
            light: 'var(--light, #EBD9F9)'
          }
        }
      }
    };
  </script>
</head>
<body id="mainBody" class="bg-light min-h-screen flex flex-row transition-all duration-300">
  <!-- å·¦å´é¸å–®ï¼ˆå¯å±•é–‹/æ‘ºç–Šï¼‰ -->
  <aside id="sidebar" class="w-96 min-h-screen bg-white shadow-lg p-6 flex flex-col gap-6 transition-all duration-300 relative">
    <div id="sidebarContent">
      <h2 class="text-xl font-bold text-dark">è¨­å®šé¢æ¿</h2>
      <div>
        <label class="block font-semibold text-dark mt-4 mb-1"># æ¨™é¡Œæ–‡å­—</label>
        <input id="settingTitle" type="text" class="w-full p-2 border border-primary rounded text-sm" value="ä¸€ç•ªè³æŠ½çæ´»å‹•" />
      </div>
      <div>
        <label class="block font-semibold text-dark mt-4 mb-1"># çé …èˆ‡æ•¸é‡</label>
        <div id="prizeSettings" class="flex flex-col gap-2"></div>
        <button id="addPrizeBtn" class="mt-2 px-3 py-1 bg-primary text-white rounded hover:bg-dark">æ–°å¢çé …</button>
      </div>
      <div>
        <label class="block font-semibold text-dark mt-4 mb-1"># ä¸»é¡Œè‰²ç³»</label>
        <div id="themeSelect" class="flex gap-2 flex-wrap"></div>
      </div>
    </div>
  </aside>
  <!-- ä¸»å…§å®¹å€ -->
  <main id="mainContent" class="flex-1 flex flex-col items-center p-6 transition-all duration-300">
    <div class="w-full max-w-[1200px] mx-auto">
      <h1 id="mainTitle" class="text-3xl font-bold mb-6 text-dark text-center">ğŸ ä¸€ç•ªè³æŠ½çæ´»å‹• ğŸ</h1>
      <div class="flex flex-wrap gap-6 w-full justify-center">
        <!-- æŠ½çæ ¼å­ -->
        <div id="grid" class="grid gap-2 max-w-[600px]"></div>
        <!-- çå“æ¸…å–®èˆ‡ ID è¼¸å…¥ -->
        <div class="bg-white p-4 rounded-xl shadow inline-block max-w-[300px] w-full">
          <h2 class="text-lg font-bold mb-2 text-dark">ğŸ¯ çå“æ¸…å–®</h2>
          <div id="prize-stats" class="text-sm space-y-2 mb-4"></div>
          <label for="userIdInput" class="block mb-1 font-semibold text-dark">ğŸ†” è«‹è¼¸å…¥æŠ½çè€…åœ–å¥‡ID</label>
          <input type="text" id="userIdInput" class="w-full p-2 border border-primary rounded text-sm" placeholder="è«‹è¼¸å…¥åœ–å¥‡ID" />
        </div>
      </div>
      <!-- æŠ½ççµæœ -->
      <div id="result" class="mt-8 mb-10 text-xl font-semibold text-dark text-center">ğŸ‰ æŠ½ççµæœ ğŸ‰</div>
      <!-- æŠ½çç´€éŒ„è¡¨ -->
      <div class="w-full max-w-[1000px] mx-auto">
        <table class="min-w-full border border-primary rounded text-left text-sm">
          <thead class="bg-primary text-white">
            <tr>
              <th class="px-4 py-2 border border-primary">çè™Ÿ</th>
              <th class="px-4 py-2 border border-primary">çå“</th>
              <th class="px-4 py-2 border border-primary">ID</th>
              <th class="px-4 py-2 border border-primary">æ™‚é–“</th>
            </tr>
          </thead>
          <tbody id="historyTableBody" class="bg-white max-h-[150px] overflow-y-auto"></tbody>
        </table>
      </div>
    </div>
  </main>
  <script>
    // ä¸»é¡Œè‰²ç³»å®šç¾©
    const themes = [
      {
        name: 'ç´«è‰²ç³»',
        primary: '#BBA0CB',
        dark: '#7E5A9B',
        light: '#EBD9F9'
      },
      {
        name: 'è—è‰²ç³»',
        primary: '#7CA7C7',
        dark: '#466B8A',
        light: '#E6F0FA'
      },
      {
        name: 'ç¶ è‰²ç³»',
        primary: '#A3C9A8',
        dark: '#5B7B6E',
        light: '#F0F7F4'
      },
      {
        name: 'ç²‰è‰²ç³»',
        primary: '#E9B7C3',
        dark: '#B97A95',
        light: '#FCE8EF'
      },
      {
        name: 'ç°è‰²ç³»',
        primary: '#B0B0B0',
        dark: '#6E6E6E',
        light: '#F5F5F5'
      }
    ];

    // è®€å– localStorage è¨­å®š
    function getSettings() {
      const defaultPrizes = [
        { name: 'Aè³ çå“A', count: 1 },
        { name: 'Bè³ çå“B', count: 5 },
        { name: 'Cè³ çå“C', count: 10 },
        { name: 'Dè³ çå“D', count: 30 }
      ];
      const settings = JSON.parse(localStorage.getItem('lotterySettings') || '{}');
      return {
        title: settings.title || 'ä¸€ç•ªè³æŠ½çæ´»å‹•',
        prizes: settings.prizes || defaultPrizes,
        themeIdx: settings.themeIdx || 0
      };
    }
    function saveSettings(settings) {
      localStorage.setItem('lotterySettings', JSON.stringify(settings));
    }

    // å‹•æ…‹æ¸²æŸ“è¨­å®šé¢æ¿
    function renderPrizeSettings(prizes) {
      const container = document.getElementById('prizeSettings');
      container.innerHTML = '';
      prizes.forEach((prize, idx) => {
        const awardCode = String.fromCharCode(65 + idx) + 'è³';
        const row = document.createElement('div');
        row.className = 'flex gap-2 items-center';
        row.innerHTML = `
          <span class="font-bold text-primary w-8">${awardCode}</span>
          <input type="text" class="p-1 border rounded w-50" value="${prize.name}" data-idx="${idx}" data-type="name" placeholder="çé …åç¨±" />
          <input type="number" min="1" class="p-1 border rounded w-16" value="${prize.count}" data-idx="${idx}" data-type="count" />
          <button class="text-red-500 font-bold" data-idx="${idx}" data-type="remove">âœ•</button>
        `;
        container.appendChild(row);
      });
    }
    function renderThemeSelect(selectedIdx) {
      const container = document.getElementById('themeSelect');
      container.innerHTML = '';
      themes.forEach((theme, idx) => {
        const btn = document.createElement('button');
        btn.className = `w-8 h-8 rounded-full border-2 ${selectedIdx === idx ? 'border-dark' : 'border-gray-300'} flex-shrink-0`;
        btn.style.background = theme.primary;
        btn.title = theme.name;
        btn.onclick = () => {
          document.querySelectorAll('#themeSelect button').forEach((b, i) => b.classList.toggle('border-dark', i === idx));
          document.getElementById('themeSelect').dataset.selected = idx;
          // ç«‹å³å¥—ç”¨ä¸»é¡Œè‰²
          applyTheme(themes[idx]);
          // å„²å­˜è¨­å®š
          const settings = getSettings();
          saveSettings({
            ...settings,
            themeIdx: idx
          });
          // ç«‹å³åˆ·æ–°ä¸»ç•«é¢
          main();
        };
        container.appendChild(btn);
      });
      container.dataset.selected = selectedIdx;
    }

    // åˆå§‹åŒ–è¨­å®šé¢æ¿
    function initSettingsPanel() {
      const settings = getSettings();
      document.getElementById('settingTitle').value = settings.title;
      renderPrizeSettings(settings.prizes);
      renderThemeSelect(settings.themeIdx);
      // æ–°å¢çé …
      document.getElementById('addPrizeBtn').onclick = () => {
        settings.prizes.push({ name: '', count: 1 });
        renderPrizeSettings(settings.prizes);
        // ç«‹å³å„²å­˜ä¸¦åˆ·æ–°
        saveSettings(settings);
        main();
      };
      // ç·¨è¼¯çé …
      document.getElementById('prizeSettings').oninput = (e) => {
        const idx = +e.target.dataset.idx;
        const type = e.target.dataset.type;
        if (type === 'name') settings.prizes[idx].name = e.target.value;
        if (type === 'count') settings.prizes[idx].count = Math.max(1, +e.target.value);
        // ç«‹å³å„²å­˜ä¸¦åˆ·æ–°
        saveSettings(settings);
        main();
      };
      // åˆªé™¤çé …
      document.getElementById('prizeSettings').onclick = (e) => {
        if (e.target.dataset.type === 'remove') {
          settings.prizes.splice(+e.target.dataset.idx, 1);
          renderPrizeSettings(settings.prizes);
          // ç«‹å³å„²å­˜ä¸¦åˆ·æ–°
          saveSettings(settings);
          main();
        }
      };
      // æ¨™é¡Œå³æ™‚æ›´æ–°
      document.getElementById('settingTitle').oninput = (e) => {
        settings.title = e.target.value;
        saveSettings(settings);
        main();
      };
    }

    // æ‡‰ç”¨ä¸»é¡Œè‰²
    function applyTheme(theme) {
      document.documentElement.style.setProperty('--primary', theme.primary);
      document.documentElement.style.setProperty('--dark', theme.dark);
      document.documentElement.style.setProperty('--light', theme.light);
    }

    // ä¸»ç¨‹å¼
    function main() {
      const settings = getSettings();
      applyTheme(themes[settings.themeIdx]);
      document.getElementById('mainTitle').textContent = settings.title;
      // ç”¢ç”Ÿçå“æ¸…å–®
      const prizeList = [];
      settings.prizes.forEach((prize, idx) => {
        const awardCode = String.fromCharCode(65 + idx) + 'è³';
        for (let i = 0; i < prize.count; i++) prizeList.push(`${awardCode} ${prize.name}`);
      });
      // æ´—ç‰Œ
      function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }
      const shuffledPrizes = shuffle([...prizeList]);
      const prizeCounts = {};
      prizeList.forEach(p => prizeCounts[p] = (prizeCounts[p] || 0) + 1);
      // æ›´æ–°çå“æ¸…å–®å€
      function updatePrizeStats() {
        const list = document.getElementById('prize-stats');
        list.innerHTML = '';
        settings.prizes.forEach((prize, idx) => {
          const awardCode = String.fromCharCode(65 + idx) + 'è³';
          const count = prizeCounts[`${awardCode} ${prize.name}`] || 0;
          const wrapper = document.createElement('div');
          wrapper.className = 'p-2 bg-white rounded border border-primary shadow-sm';
          const header = document.createElement('div');
          header.innerHTML = `
            <span class="text-primary font-bold">ã€${awardCode}ã€‘</span>
            <span class="text-dark font-semibold ml-2">å‰©é¤˜ ${count} ä»¶</span>
          `;
          const content = document.createElement('div');
          content.className = 'mt-1 bg-light text-dark font-bold p-1 rounded text-sm';
          content.textContent = prize.name;
          wrapper.appendChild(header);
          wrapper.appendChild(content);
          list.appendChild(wrapper);
        });
      }
      updatePrizeStats();
      // å»ºç«‹æŠ½çæ ¼å­
      const grid = document.getElementById('grid');
      grid.className = `grid gap-2 max-w-[600px] grid-cols-${Math.min(10, Math.ceil(Math.sqrt(prizeList.length)))}`;
      grid.innerHTML = '';
      const result = document.getElementById('result');
      const userIdInput = document.getElementById('userIdInput');
      const historyTableBody = document.getElementById('historyTableBody');
      const drawnResults = [];
      for (let i = 0; i < prizeList.length; i++) {
        const btn = document.createElement('button');
        btn.className = `bg-primary hover:bg-dark text-white font-bold text-base w-14 h-14 rounded flex items-center justify-center transition`;
        btn.textContent = i + 1;
        btn.dataset.index = i;
        btn.onclick = function () {
          if (btn.disabled) return;
          const userId = userIdInput.value.trim();
          if (!userId) {
            alert('â— è«‹å…ˆè¼¸å…¥æŠ½çè€…IDå†é€²è¡ŒæŠ½ç â—');
            return;
          }
          btn.classList.add('draw-animate');
          btn.disabled = true;
          btn.addEventListener('animationend', function handler() {
            btn.classList.remove('draw-animate');
            btn.classList.add('fade-out');
            btn.addEventListener('transitionend', function fadeHandler() {
              btn.className = 'bg-transparent border border-transparent text-transparent font-semibold w-14 h-14 rounded flex items-center justify-center';
              btn.textContent = '';
              btn.removeEventListener('transitionend', fadeHandler);
            });
            btn.removeEventListener('animationend', handler);
          });
          const prize = shuffledPrizes[i];
          const now = new Date();
          const timestamp = `${now.getFullYear()}/${now.getMonth() + 1}/${now.getDate()} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
          drawnResults.unshift({
            number: i + 1,
            prize,
            userId,
            time: timestamp
          });
          if (prizeCounts[prize] > 0) {
            prizeCounts[prize]--;
          } else {
            prizeCounts[prize] = 0;
          }
          updatePrizeStats();
          result.textContent = `ğŸ‰ ${userId} æŠ½ä¸­äº†ã€#${i + 1}ã€‘ï¼š${prize}ï¼`;
          updateHistoryTable();
        };
        grid.appendChild(btn);
      }
      // æŠ½çç´€éŒ„è¡¨
      function updateHistoryTable() {
        historyTableBody.innerHTML = '';
        drawnResults.forEach(record => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="border border-primary px-4 py-1 font-extrabold">${record.number}</td>
            <td class="border border-primary px-4 py-1">${record.prize}</td>
            <td class="border border-primary px-4 py-1">${record.userId}</td>
            <td class="border border-primary px-4 py-1">${record.time}</td>
          `;
          historyTableBody.appendChild(tr);
        });
      }
    }
    // é˜²åˆ·æ–°è­¦å‘Š
    let allowUnload = false;
    window.addEventListener('beforeunload', function (e) {
      if (!allowUnload) {
        e.preventDefault();
        e.returnValue = '';
        return '';
      }
    });
    window.addEventListener('unload', function () {
      allowUnload = true;
    });
    // åˆå§‹åŒ–
    initSettingsPanel();
    main();
  </script>
</body>
</html>
